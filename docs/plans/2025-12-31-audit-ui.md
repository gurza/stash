# Audit Trail UI Implementation Plan

## Overview

Add a web UI for viewing and querying audit logs. Accessible only to admin users via a dedicated `/audit` page with full filtering capabilities.

## Context

- Files involved: `app/server/web/`, `app/server/web/templates/`
- Related patterns: existing table view, HTMX partials, admin-only checks
- Dependencies: audit API already exists (`POST /audit/query`)
- **Update this plan**: mark checkboxes as complete during implementation

## Tasks

### 1. Add Audit Page Route and Handler

**Files:**
- Modify: `app/server/web/handler.go`
- Create: `app/server/web/audit.go`

- [ ] Add `GET /audit` route in handler.go
- [ ] Create `HandleAuditPage` - render full audit.html with initial data
- [ ] Create `HandleAuditTable` - return audit-table.html partial for HTMX
- [ ] Add admin-only access check (reuse existing pattern from audit.go)
- [ ] Add tests for handlers
- [ ] Verify tests pass

### 2. Create Audit Templates

**Files:**
- Create: `app/server/web/templates/audit.html`
- Create: `app/server/web/templates/partials/audit-table.html`

- [ ] Create audit.html with header, collapsible filter panel, table container
- [ ] Create audit-table.html partial with table rows and pagination
- [ ] Add filter form with: key prefix, actor, action dropdown, result dropdown, actor_type dropdown, from/to datetime inputs
- [ ] Add HTMX attributes for filter-on-change with debounce
- [ ] Add color-coded badges for action (create=green, read=blue, update=yellow, delete=red)
- [ ] Add color-coded badges for result (success=green, denied=red, not_found=gray)
- [ ] Add relative timestamps with full timestamp on hover

### 3. Add Audit Link to Header

**Files:**
- Modify: `app/server/web/templates/index.html`
- Modify: `app/server/web/handler.go` (add IsAdmin to template data)

- [ ] Add audit log icon in header actions (visible only to admins)
- [ ] Pass IsAdmin flag to index template data
- [ ] Add tests for admin visibility

### 4. Add CSS Styles

**Files:**
- Modify: `app/server/static/styles.css`

- [ ] Add filter panel styles (collapsible)
- [ ] Add audit table styles (reuse existing table patterns)
- [ ] Add badge color classes for actions and results
- [ ] Add row tinting for denied/not_found results

### 5. Add E2E Tests

**Files:**
- Create: `e2e/audit_test.go`

- [ ] TestAudit_AdminCanViewPage - admin sees audit page
- [ ] TestAudit_NonAdminForbidden - non-admin user gets 403
- [ ] TestAudit_FiltersWork - apply filters, verify table updates
- [ ] TestAudit_PaginationWorks - navigate pages
- [ ] TestAudit_HeaderLinkVisibleForAdmin - admin sees icon
- [ ] TestAudit_HeaderLinkHiddenForNonAdmin - non-admin doesn't see icon

### 6. Final Validation

- [ ] Run full test suite
- [ ] Run linter
- [ ] Run e2e tests
- [ ] Move plan to `docs/plans/completed/`
