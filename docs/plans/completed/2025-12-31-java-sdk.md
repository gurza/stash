# Java SDK Implementation

## Overview
Add Java client library for Stash with zero-knowledge encryption support. Published to GitHub Packages for easy consumption in enterprise environments.

**Key requirements:**
- Idiomatic, modern Java (11+ baseline, modern patterns)
- Full data-level compatibility with Go, Python, TypeScript SDKs
- Same ZK encryption format (`$ZK$<base64>`) for cross-SDK interoperability

## Context

**Existing SDKs analyzed:**
- `lib/stash/` - Go SDK (functional options, go-pkgz/requester)
- `lib/stash-python/` - Python SDK (urllib3, argon2-cffi)
- `lib/stash-js/` - TypeScript SDK (fetch, hash-wasm, WebCrypto)

**ZK crypto parameters (MUST MATCH EXACTLY):**
```
Prefix: "$ZK$"
Salt: 16 bytes
Nonce: 12 bytes (AES-GCM standard)
Key: 32 bytes (AES-256)
Min passphrase: 16 bytes UTF-8

Argon2id:
  iterations: 1
  memory: 64 * 1024 KB (64 MB)
  parallelism: 4
  output: 32 bytes
```

**Cross-compat test passphrase:** `"cross-compat-key-16"`

## Iterative Development Approach
- Complete each step fully before moving to the next
- Make small, focused changes
- **CRITICAL: every iteration must end with adding/updating tests**
- **CRITICAL: all tests must pass before starting next iteration**
- **CRITICAL: update this plan file when scope changes during implementation**

## Progress Tracking
- Mark completed items with `[x]` immediately when done
- Add newly discovered tasks with ➕ prefix
- Document issues/blockers with ⚠️ prefix

## Implementation Steps

### Iteration 1: Project Setup
- [ ] Create `lib/stash-java/` directory structure
- [ ] Add `build.gradle.kts` with dependencies:
  - `java.net.http.HttpClient` (built-in, Java 11+)
  - `com.google.code.gson:gson` for JSON
  - `org.bouncycastle:bcprov-jdk18on` for Argon2id
  - JUnit 5, okhttp3 MockWebServer for testing
- [ ] Add `settings.gradle.kts`
- [ ] Configure GitHub Packages publishing
- [ ] Create package structure: `com.github.umputun.stash`
- [ ] **Verify Gradle build works**
- [ ] **Run empty test suite**

### Iteration 2: Core Types and Errors
- [ ] Create `Format.java` enum (TEXT, JSON, YAML, XML, TOML, INI, HCL, SHELL)
- [ ] Create `KeyInfo.java` class (key, size, format, secret, zkEncrypted, createdAt, updatedAt)
- [ ] Create error hierarchy in `errors/` package:
  - `StashException` (base)
  - `NotFoundError`
  - `UnauthorizedError`
  - `ForbiddenError`
  - `DecryptionError`
  - `ConnectionError`
- [ ] **Add unit tests for Format enum and KeyInfo**
- [ ] **Run tests - must pass before iteration 3**

### Iteration 3: ZK Encryption
- [ ] Create `ZKCrypto.java` with exact parameters matching other SDKs
- [ ] Implement `deriveKey(passphrase, salt)` using BouncyCastle Argon2
- [ ] Implement `encrypt(plaintext)` → `$ZK$<base64>`
- [ ] Implement `decrypt(ciphertext)` → plaintext
- [ ] Implement `isZKEncrypted(value)` detection
- [ ] Validate passphrase minimum 16 bytes (not characters)
- [ ] **Add ZK unit tests**
- [ ] **Copy fixtures from TypeScript SDK for cross-compat tests**
- [ ] **Add cross-compatibility tests (decrypt Go/Python/TS fixtures)**
- [ ] **Run tests - must pass before iteration 4**

### Iteration 4: Client Options
- [ ] Create `ClientOptions.java` with Builder pattern:
  ```java
  ClientOptions.builder()
      .token("...")
      .timeout(Duration.ofSeconds(30))
      .retries(3)
      .retryDelay(Duration.ofMillis(100))
      .zkKey("passphrase")
      .build()
  ```
- [ ] Validate options (timeout > 0, retries >= 0, zkKey >= 16 bytes)
- [ ] **Add ClientOptions tests**
- [ ] **Run tests - must pass before iteration 5**

### Iteration 5: HTTP Client Core
- [ ] Create `Client.java` implementing `Closeable`
- [ ] Implement `Client.builder(baseUrl)` factory
- [ ] Implement internal HTTP methods with retry logic:
  - Exponential backoff
  - Timeout handling
  - Error response parsing
- [ ] Implement `ping()` method
- [ ] **Add Client tests with MockWebServer**
- [ ] **Run tests - must pass before iteration 6**

### Iteration 6: CRUD Operations
- [ ] Implement `get(key)` → String (with ZK auto-decrypt)
- [ ] Implement `getBytes(key)` → byte[]
- [ ] Implement `getOrDefault(key, defaultValue)`
- [ ] Implement `set(key, value)` (with ZK auto-encrypt)
- [ ] Implement `set(key, value, format)`
- [ ] Implement `delete(key)`
- [ ] Validate empty key throws exception
- [ ] **Add CRUD tests with mocked server**
- [ ] **Run tests - must pass before iteration 7**

### Iteration 7: List and Info Operations
- [ ] Implement `list()` → List<KeyInfo>
- [ ] Implement `list(prefix)` → List<KeyInfo>
- [ ] Implement `info(key)` → KeyInfo
- [ ] Parse JSON responses with Gson
- [ ] **Add list/info tests**
- [ ] **Run tests - must pass before iteration 8**

### Iteration 8: CI Integration
- [ ] Add `java-sdk` job to `.github/workflows/ci.yml`
- [ ] Create `.github/workflows/publish-maven.yml` for GitHub Packages
- [ ] **Verify CI passes locally with `./gradlew check`**
- [ ] **Run full test suite**

### Iteration 9: Documentation
- [ ] Create `lib/stash-java/README.md` with:
  - Installation (GitHub Packages setup)
  - Basic usage examples
  - ZK encryption usage
  - API reference
- [ ] Update main `README.md` with Java SDK section
- [ ] Update `CHANGELOG.md`
- [ ] **Verify all tests still pass**

### Iteration 10: Completion
- [ ] Mark all tasks above as completed
- [ ] Verify plan reflects actual implementation
- [ ] Generate Java SDK encrypted fixture for other SDKs
- [ ] Run full test suite one final time
- [ ] Move this plan to `docs/plans/completed/`

## Technical Details

### Project Structure
```
lib/stash-java/
├── build.gradle.kts
├── settings.gradle.kts
├── README.md
├── src/main/java/com/github/umputun/stash/
│   ├── Client.java
│   ├── ClientOptions.java
│   ├── ZKCrypto.java
│   ├── KeyInfo.java
│   ├── Format.java
│   └── errors/
│       ├── StashException.java
│       ├── NotFoundError.java
│       ├── UnauthorizedError.java
│       ├── ForbiddenError.java
│       ├── DecryptionError.java
│       └── ConnectionError.java
└── src/test/java/com/github/umputun/stash/
    ├── ClientTest.java
    ├── ZKCryptoTest.java
    ├── CrossCompatTest.java
    └── resources/fixtures/
```

### Java Idioms Used
- Builder pattern for ClientOptions and Client
- `Closeable` interface for resource management
- `Optional` for nullable returns where appropriate
- `Duration` for time values (not raw milliseconds)
- Immutable value objects where possible
- Package-private for internal classes
- Javadoc for public API

### HTTP API Endpoints
```
GET    /kv/{key}           → raw value bytes
PUT    /kv/{key}           → store value (X-Stash-Format header)
DELETE /kv/{key}           → delete key
GET    /kv/?prefix={p}     → JSON array of KeyInfo
GET    /ping               → "pong"
```

### GitHub Packages Usage
```gradle
repositories {
    maven {
        url = uri("https://maven.pkg.github.com/umputun/stash")
        credentials {
            username = project.findProperty("gpr.user") ?: System.getenv("GITHUB_ACTOR")
            password = project.findProperty("gpr.key") ?: System.getenv("GITHUB_TOKEN")
        }
    }
}

dependencies {
    implementation("com.github.umputun:stash-client:0.1.0")
}
```
